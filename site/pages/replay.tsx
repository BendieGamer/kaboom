import * as React from "react"
import Editor, { EditorRef } from "comps/Editor"
import GameView, { GameViewRef } from "comps/GameView"
import Button from "comps/Button"
import View from "comps/View"
import Background from "comps/Background"
import {
	ChangeSet,
} from "@codemirror/state"

const record = {"doc":"kaboom();\n\n// load default sprite \"bean\"\nloadBean();\n\n// add to screen\nadd([\n\tsprite(\"bean\"),\n\tpos(80, 40),\n]);","initTime":1655962737281,"actions":[[689,"c",[111]],[699,"c",[111]],[750,"c",[111]],[988,"c",[52,[0,"",""],59]],[1021,"c",[112]],[1098,"c",[53,[0,"",""],59]],[1152,"c",[113]],[1253,"c",[54,[0,"/"],59]],[1306,"c",[114]],[1368,"c",[55,[0,"/"],59]],[1417,"c",[115]],[1544,"c",[56,[0," "],59]],[1629,"c",[57,[0,"o"],59]],[1636,"c",[117]],[1702,"c",[58,[0,"h"],59]],[1719,"c",[118]],[1767,"c",[118]],[1799,"c",[59,[0," "],59]],[1850,"c",[60,[0,"h"],59]],[1900,"c",[120]],[1939,"c",[61,[0,"i"],59]],[1969,"c",[121]],[2058,"c",[121]],[2210,"c",[62,[0,"!"],59]],[2269,"c",[122]],[2306,"c",[122]],[2475,"c",[63,[0,"",""],59]],[2524,"c",[123]],[2837,"c",[64,[0,"b"],59]],[2898,"c",[65,[0,"u"],59]],[2941,"c",[125]],[2970,"c",[66,[0,"r"],59]],[2993,"c",[126]],[3071,"c",[126]],[3115,"c",[67,[0,"p"],59]],[3180,"c",[127]],[3371,"c",[68,[0,"*"],59]],[3430,"c",[128]],[3514,"c",[128]],[3936,"c",[68,[1],59]],[4010,"c",[127]],[4174,"c",[68,[0,"*"],59]],[4233,"c",[128]],[4422,"c",[128]],[4467,"c",[68,[1],59]],[4523,"c",[127]],[4621,"c",[68,[0,"()"],59]],[4689,"c",[129]],[4741,"c",[129]],[5494,"c",[129]],[5566,"r"],[6186,"c",[129]],[6248,"c",[129]],[6750,"c",[129]],[6815,"c",[129]],[7092,"c",[125,[0,"","\t"],4]],[7152,"c",[131]],[8567,"c",[131]],[8631,"c",[131]],[8700,"c",[131]],[8749,"c",[131]],[8845,"c",[117,[2,"3"],12]],[8934,"c",[130]],[8940,"c",[118,[0,"0"],12]],[8987,"c",[131]],[9047,"c",[119,[0,"0"],12]],[9099,"c",[132]],[9895,"c",[132]],[9936,"r"],[10651,"c",[132]],[10731,"c",[132]],[11050,"c",[128,[0,"b"],4]],[11114,"c",[133]],[11343,"c",[128,[1],4]],[11397,"c",[132]],[11402,"c",[128,[0,"a"],4]],[11501,"c",[133]],[11526,"c",[129,[0,"r"],4]],[11586,"c",[130,[0,"e"],4]],[11649,"c",[131,[0,"a"],4]],[11654,"c",[136]],[11687,"c",[136]],[11777,"c",[136]],[12023,"c",[132,[0,"()"],4]],[12120,"c",[138]],[12164,"c",[138]],[12304,"c",[138]],[12376,"c",[138]],[12487,"c",[134,[0,","],4]],[12549,"c",[139]],[12645,"c",[135,[0,"","\t"],4]],[12707,"c",[141]],[12850,"c",[137,[0,"b"],4]],[12899,"c",[138,[0,"o"],4]],[12932,"c",[143]],[12980,"c",[143]],[12985,"c",[139,[0,"d"],4]],[13081,"c",[144]],[13085,"c",[140,[0,"y"],4]],[13155,"c",[145]],[13327,"c",[141,[0,"()"],4]],[13401,"c",[147]],[13465,"c",[147]],[13810,"c",[147]],[13886,"c",[147]],[13999,"c",[143,[0,","],4]],[14065,"c",[148]],[14583,"c",[148]],[14649,"c",[148]],[15245,"c",[148]],[15316,"r"],[16101,"c",[148]],[16182,"c",[148]],[16417,"c",[52,[0,"",""],96]],[16455,"c",[149]],[16517,"c",[53,[0,"",""],96]],[16581,"c",[150]],[16656,"c",[54,[0,"g"],96]],[16718,"c",[151]],[16808,"c",[55,[0,"r"],96]],[16871,"c",[56,[0,"a"],96]],[16897,"c",[153]],[16948,"c",[153]],[17008,"c",[57,[0,"v"],96]],[17098,"c",[154]],[17117,"c",[58,[0,"i"],96]],[17190,"c",[59,[0,"t"],96]],[17197,"c",[156]],[17247,"c",[156]],[17316,"c",[60,[0,"y"],96]],[17382,"c",[157]],[17501,"c",[61,[0,"()"],96]],[17598,"c",[159]],[17601,"c",[159]],[17734,"c",[62,[0,"1"],97]],[17775,"c",[63,[0,"0"],97]],[17800,"c",[161]],[17825,"c",[161]],[17883,"c",[64,[0,"0"],97]],[17916,"c",[162]],[17974,"c",[65,[0,"0"],97]],[18024,"c",[163]],[18711,"c",[163]],[18782,"r"],[19585,"c",[163]],[19649,"c",[163]],[20261,"c",[163]],[20349,"r"],[20899,"c",[163]],[20998,"c",[163]],[21417,"c",[163]],[21516,"c",[163]],[22100,"c",[163]],[22181,"c",[163]],[22386,"c",[53,[0,"",""],110]],[22435,"c",[164]],[22635,"c",[54,[0,"/"],110]],[22689,"c",[165]],[22762,"c",[55,[0,"/"],110]],[22797,"c",[166]],[22877,"c",[56,[0," "],110]],[22962,"c",[57,[0,"d"],110]],[22973,"c",[168]],[23037,"c",[58,[0,"o"],110]],[23058,"c",[169]],[23084,"c",[59,[0,"n"],110]],[23114,"c",[170]],[23170,"c",[170]],[23186,"c",[60,[0,"e"],110]],[23305,"c",[171]],[24260,"c",[171]]]}

const Page: React.FC = () => {
	const editorRef = React.useRef<EditorRef | null>(null)
	const gameviewRef = React.useRef<GameViewRef | null>(null)
	return (
		<Background pad={2} dir="column" gap={2} css={{ overflow: "scroll" }}>
			<View dir="row" gap={2}>
				<Button text={"Play Recording"} action={() => {
					const view = editorRef.current?.getView()
					if (!view) return
					for (const action of record.actions) {
						const [ time, ty, data ] = action
						setTimeout(() => {
							if (ty === "c") {
								view?.dispatch({
									changes: ChangeSet.fromJSON(data),
								})
							} else if (ty === "r") {
								const content = editorRef.current?.getContent()
								if (content) {
									gameviewRef.current?.run(content)
								}
							}
						}, time)
					}
				}} />
			</View>
			<View stretch dir="row" gap={2}>
				<Editor
					name="Code Editor"
					desc="Edit your code here!"
					ref={editorRef}
					width="80%"
					stretchY
					placeholder="Congrats you have discovered the placeholder text"
					content={record.doc}
				/>
				<GameView
					name="Game View"
					desc="Where your game runs"
					ref={gameviewRef}
					code={record.doc}
					stretch
				/>
			</View>
		</Background>
	)
}

export default Page
